const keysData = {
  en: [
    {
      code: 'Backquote',
      value: '`',
      shift: '~',
    },
    {
      code: 'Digit1',
      value: '1',
      shift: '!',
    },
    {
      code: 'Digit2',
      value: '2',
      shift: '@',
    },
    {
      code: 'Digit3',
      value: '3',
      shift: '#',
    },
    {
      code: 'Digit4',
      value: '4',
      shift: '$',
    },
    {
      code: 'Digit5',
      value: '5',
      shift: '%',
    },
    {
      code: 'Digit6',
      value: '6',
      shift: '^',
    },
    {
      code: 'Digit7',
      value: '7',
      shift: '&',
    },
    {
      code: 'Digit8',
      value: '8',
      shift: '*',
    },
    {
      code: 'Digit9',
      value: '9',
      shift: '(',
    },
    {
      code: 'Digit0',
      value: '0',
      shift: ')',
    },
    {
      code: 'Minus',
      value: '-',
      shift: '_',
    },
    {
      code: 'Equal',
      value: '=',
      shift: '+',
    },
    {
      code: 'Backspace',
      value: 'Backspace',
      shift: null,
    },
    {
      code: 'Tab',
      value: 'Tab',
      shift: null,
    },
    {
      code: 'KeyQ',
      value: 'q',
      shift: 'Q',
    },
    {
      code: 'KeyW',
      value: 'w',
      shift: 'W',
    },
    {
      code: 'KeyE',
      value: 'e',
      shift: 'E',
    },
    {
      code: 'KeyR',
      value: 'r',
      shift: 'R',
    },
    {
      code: 'KeyT',
      value: 't',
      shift: 'T',
    },
    {
      code: 'KeyY',
      value: 'y',
      shift: 'Y',
    },
    {
      code: 'KeyU',
      value: 'u',
      shift: 'U',
    },
    {
      code: 'KeyI',
      value: 'i',
      shift: 'I',
    },
    {
      code: 'KeyO',
      value: 'o',
      shift: 'O',
    },
    {
      code: 'KeyP',
      value: 'p',
      shift: 'P',
    },
    {
      code: 'BracketLeft',
      value: '[',
      shift: '{',
    },
    {
      code: 'BracketRight',
      value: ']',
      shift: '}',
    },
    {
      code: 'Backslash',
      value: '\\',
      shift: '|',
    },
    {
      code: 'Delete',
      value: 'Del',
      shift: null,
    },
    {
      code: 'CapsLock',
      value: 'CapsLock',
      shift: null,
    },
    {
      code: 'KeyA',
      value: 'a',
      shift: 'A',
    },
    {
      code: 'KeyS',
      value: 's',
      shift: 'S',
    },
    {
      code: 'KeyD',
      value: 'd',
      shift: 'D',
    },
    {
      code: 'KeyF',
      value: 'f',
      shift: 'F',
    },
    {
      code: 'KeyG',
      value: 'g',
      shift: 'G',
    },
    {
      code: 'KeyH',
      value: 'h',
      shift: 'H',
    },
    {
      code: 'KeyJ',
      value: 'j',
      shift: 'J',
    },
    {
      code: 'KeyK',
      value: 'k',
      shift: 'K',
    },
    {
      code: 'KeyL',
      value: 'l',
      shift: 'L',
    },
    {
      code: 'Semicolon',
      value: ';',
      shift: ':',
    },
    {
      code: 'Quote',
      value: "'",
      shift: '"',
    },
    {
      code: 'Enter',
      value: 'Enter',
      shift: null,
    },
    {
      code: 'ShiftLeft',
      value: 'Shift',
      shift: null,
    },
    {
      code: 'KeyZ',
      value: 'z',
      shift: 'Z',
    },
    {
      code: 'KeyX',
      value: 'x',
      shift: 'X',
    },
    {
      code: 'KeyC',
      value: 'c',
      shift: 'C',
    },
    {
      code: 'KeyV',
      value: 'v',
      shift: 'V',
    },
    {
      code: 'KeyB',
      value: 'b',
      shift: 'B',
    },
    {
      code: 'KeyN',
      value: 'n',
      shift: 'N',
    },
    {
      code: 'KeyM',
      value: 'm',
      shift: 'M',
    },
    {
      code: 'Comma',
      value: ',',
      shift: '<',
    },
    {
      code: 'Period',
      value: '.',
      shift: '>',
    },
    {
      code: 'Slash',
      value: '/',
      shift: '?',
    },
    {
      code: 'ShiftRight',
      value: 'Shift',
      shift: null,
    },
    {
      code: 'ControlLeft',
      value: 'Ctrl',
      shift: null,
    },
    {
      code: 'MetaLeft',
      value: 'Win',
      shift: null,
    },
    {
      code: 'AltLeft',
      value: 'Alt',
      shift: null,
    },
    {
      code: 'Space',
      value: ' ',
      shift: null,
    },
    {
      code: 'AltRight',
      value: 'Alt',
      shift: null,
    },
    {
      code: 'ControlRight',
      value: 'Ctrl',
      shift: null,
    },
    {
      code: 'ArrowLeft',
      value: '⇦',
      shift: null,
    },
    {
      code: 'ArrowUp',
      value: '⇧',
      shift: null,
    },
    {
      code: 'ArrowDown',
      value: '⇩',
      shift: null,
    },
    {
      code: 'ArrowRight',
      value: '⇨',
      shift: null,
    },
  ],
  ru: [
    {
      code: 'Backquote',
      value: 'ё',
      shift: 'Ё',
    },
    {
      code: 'Digit1',
      value: '1',
      shift: '!',
    },
    {
      code: 'Digit2',
      value: '2',
      shift: '"',
    },
    {
      code: 'Digit3',
      value: '3',
      shift: '№',
    },
    {
      code: 'Digit4',
      value: '4',
      shift: ';',
    },
    {
      code: 'Digit5',
      value: '5',
      shift: '%',
    },
    {
      code: 'Digit6',
      value: '6',
      shift: ':',
    },
    {
      code: 'Digit7',
      value: '7',
      shift: '?',
    },
    {
      code: 'Digit8',
      value: '8',
      shift: '*',
    },
    {
      code: 'Digit9',
      value: '9',
      shift: '(',
    },
    {
      code: 'Digit0',
      value: '0',
      shift: ')',
    },
    {
      code: 'Minus',
      value: '-',
      shift: '_',
    },
    {
      code: 'Equal',
      value: '=',
      shift: '+',
    },
    {
      code: 'Backspace',
      value: 'Backspace',
      shift: null,
    },
    {
      code: 'Tab',
      value: 'Tab',
      shift: null,
    },
    {
      code: 'KeyQ',
      value: 'й',
      shift: 'Й',
    },
    {
      code: 'KeyW',
      value: 'ц',
      shift: 'Ц',
    },
    {
      code: 'KeyE',
      value: 'у',
      shift: 'У',
    },
    {
      code: 'KeyR',
      value: 'к',
      shift: 'К',
    },
    {
      code: 'KeyT',
      value: 'е',
      shift: 'Е',
    },
    {
      code: 'KeyY',
      value: 'н',
      shift: 'Н',
    },
    {
      code: 'KeyU',
      value: 'г',
      shift: 'Г',
    },
    {
      code: 'KeyI',
      value: 'ш',
      shift: 'Ш',
    },
    {
      code: 'KeyO',
      value: 'щ',
      shift: 'Щ',
    },
    {
      code: 'KeyP',
      value: 'з',
      shift: 'З',
    },
    {
      code: 'BracketLeft',
      value: 'х',
      shift: 'Х',
    },
    {
      code: 'BracketRight',
      value: 'ъ',
      shift: 'Ъ',
    },
    {
      code: 'Backslash',
      value: '\\',
      shift: '/',
    },
    {
      code: 'Delete',
      value: 'Del',
      shift: null,
    },
    {
      code: 'CapsLock',
      value: 'CapsLock',
      shift: null,
    },
    {
      code: 'KeyA',
      value: 'ф',
      shift: 'Ф',
    },
    {
      code: 'KeyS',
      value: 'ы',
      shift: 'Ы',
    },
    {
      code: 'KeyD',
      value: 'в',
      shift: 'В',
    },
    {
      code: 'KeyF',
      value: 'а',
      shift: 'А',
    },
    {
      code: 'KeyG',
      value: 'п',
      shift: 'П',
    },
    {
      code: 'KeyH',
      value: 'р',
      shift: 'Р',
    },
    {
      code: 'KeyJ',
      value: 'о',
      shift: 'О',
    },
    {
      code: 'KeyK',
      value: 'л',
      shift: 'Л',
    },
    {
      code: 'KeyL',
      value: 'д',
      shift: 'Д',
    },
    {
      code: 'Semicolon',
      value: 'ж',
      shift: 'Ж',
    },
    {
      code: 'Quote',
      value: 'э',
      shift: 'Э',
    },
    {
      code: 'Enter',
      value: 'Enter',
      shift: null,
    },
    {
      code: 'ShiftLeft',
      value: 'Shift',
      shift: null,
    },
    {
      code: 'KeyZ',
      value: 'я',
      shift: 'Я',
    },
    {
      code: 'KeyX',
      value: 'ч',
      shift: 'Ч',
    },
    {
      code: 'KeyC',
      value: 'с',
      shift: 'С',
    },
    {
      code: 'KeyV',
      value: 'м',
      shift: 'М',
    },
    {
      code: 'KeyB',
      value: 'и',
      shift: 'И',
    },
    {
      code: 'KeyN',
      value: 'т',
      shift: 'Т',
    },
    {
      code: 'KeyM',
      value: 'ь',
      shift: 'Ь',
    },
    {
      code: 'Comma',
      value: 'б',
      shift: 'Б',
    },
    {
      code: 'Period',
      value: 'ю',
      shift: 'Ю',
    },
    {
      code: 'Slash',
      value: '.',
      shift: ',',
    },
    {
      code: 'ShiftRight',
      value: 'Shift',
      shift: null,
    },
    {
      code: 'ControlLeft',
      value: 'Ctrl',
      shift: null,
    },
    {
      code: 'MetaLeft',
      value: 'Win',
      shift: null,
    },
    {
      code: 'AltLeft',
      value: 'Alt',
      shift: null,
    },
    {
      code: 'Space',
      value: ' ',
      shift: null,
    },
    {
      code: 'AltRight',
      value: 'Alt',
      shift: null,
    },
    {
      code: 'ControlRight',
      value: 'Ctrl',
      shift: null,
    },
    {
      code: 'ArrowLeft',
      value: '⇦',
      shift: null,
    },
    {
      code: 'ArrowUp',
      value: '⇧',
      shift: null,
    },
    {
      code: 'ArrowDown',
      value: '⇩',
      shift: null,
    },
    {
      code: 'ArrowRight',
      value: '⇨',
      shift: null,
    },
  ],
};

const layout = {
  createEl(tag, properties = {}) {
    let element;
    try {
      element = document.createElement(tag);
    } catch (err) {
      throw new Error('No element tag name');
    }

    if (properties.classes) element.classList.add(...properties.classes);

    if (properties.content) {
      if (typeof properties.content === 'string') {
        element.innerHTML = properties.content;
      } else {
        element.append(...properties.content);
      }
    }

    if (properties.attrs) {
      Object.keys(properties.attrs).forEach((attr) => {
        if (typeof properties.attrs[attr] === 'string' || typeof properties.attrs[attr] === 'number') {
          element.setAttribute(attr, properties.attrs[attr]);
        } else {
          element[attr] = properties.attrs[attr];
        }
      });
    }

    if (properties.dataset) {
      Object.keys(properties.dataset).forEach((key) => {
        element.dataset[key] = properties.dataset[key];
      });
    }
    return element;
  },
  setStorage(key, value) {
    window.localStorage.setItem(key, JSON.stringify(value));
  },
  getStorage(key, def = '"en"') {
    return JSON.parse(window.localStorage.getItem(key) || def);
  },
};

class Key {
  constructor(keyCode, lang) {
    this.data = {};
    this.code = keyCode;
    Object.keys(keysData).forEach((language) => {
      this.data[language] = keysData[language].find((keyData) => keyData.code === keyCode);
    });
    this.subtitle = layout.createEl('span', { classes: ['key__subtitle'], content: this.data[lang].shift });

    if (this.data[lang].shift === this.data[lang].value.toUpperCase()) {
      this.subtitle.innerHTML = '';
    }

    this.title = layout.createEl('span', { classes: ['key__title'], content: this.data[lang].value });

    const properties = {
      classes: ['keyboard__key'],
      content: [this.subtitle, this.title],
      dataset: {
        code: keyCode,
      },
    };
    this.element = layout.createEl('div', properties);
    this.currentValue = this.data[lang].value;
  }

  mouseLeave = () => {
    this.unpress();
    this.element.removeEventListener('mouseleave', this.mouseLeave);
    this.element.removeEventListener('mouseup', this.mouseLeave);
  };

  press(repeat) {
    this.element.classList.add('keyboard__key_active');
    if (this.code.match(/Control/)) {
      if (this.code.match(/Left/)) {
        this.keyboard.ctrlLeft = true;
        if (!repeat) {
          if (this.keyboard.altLeft) this.keyboard.switchLang();
        }
      } else {
        this.keyboard.ctrlRight = true;
      }
      return;
    }
    if (this.code.match(/Alt/)) {
      if (this.code.match(/Left/)) {
        this.keyboard.altLeft = true;
        if (!repeat) {
          if (this.keyboard.ctrlLeft) this.keyboard.switchLang();
        }
      } else {
        this.keyboard.altRight = true;
      }
      return;
    }

    if (this.code.match(/Shift/)) {
      if (this.code.match(/Left/)) {
        this.keyboard.shiftLeft = true;
      } else {
        this.keyboard.shiftRight = true;
      }
      if (!repeat) {
        this.keyboard.switchCase();
      }
      return;
    }

    if (this.code.match(/Caps/)) {
      if (this.keyboard.capsKeyPressed) return;
      this.keyboard.capsKeyPressed = true;
      if (!repeat) {
        this.keyboard.caps = !this.keyboard.caps;
        this.keyboard.switchCase();
      }
      return;
    }
    if (this.code.match(/Meta/)) {
      return;
    }

    this.print();
  }

  print() {
    const { output } = this.keyboard;
    output.focus();
    const caretPosStart = output.selectionStart;
    const caretPosEnd = output.selectionEnd;

    const textBefore = this.keyboard.output.value.slice(0, caretPosStart);
    const textAfter = this.keyboard.output.value.slice(caretPosEnd);

    if (this.currentValue.length === 1) {
      this.keyboard.output.value = textBefore + this.currentValue + textAfter;
      output.selectionStart = caretPosStart + 1;
      output.selectionEnd = caretPosStart + 1;
    }

    if (this.code.match(/Backspace/)) {
      if (caretPosStart === caretPosEnd) {
        const textBeforeСorrected = textBefore.slice(0, caretPosStart - 1);
        this.keyboard.output.value = textBeforeСorrected + textAfter;
        if (textBefore.length) {
          output.selectionStart = caretPosStart - 1;
          output.selectionEnd = caretPosStart - 1;
        }
      } else {
        this.keyboard.output.value = textBefore + textAfter;
        output.selectionStart = caretPosStart;
        output.selectionEnd = caretPosStart;
      }
    }
    if (this.code.match(/Delete/)) {
      if (caretPosStart === caretPosEnd) {
        const textAfterСorrected = textAfter.slice(1);
        this.keyboard.output.value = textBefore + textAfterСorrected;
        output.selectionStart = caretPosStart;
        output.selectionEnd = caretPosStart;
      } else {
        this.keyboard.output.value = textBefore + textAfter;
        output.selectionStart = caretPosStart;
        output.selectionEnd = caretPosStart;
      }
    }
    if (this.code.match(/Tab/)) {
      this.keyboard.output.value = `${textBefore}\t${textAfter}`;
      output.selectionStart = caretPosStart + 1;
      output.selectionEnd = caretPosStart + 1;
    }
    if (this.code.match(/Enter/)) {
      this.keyboard.output.value = `${textBefore}\n${textAfter}`;
      output.selectionStart = caretPosStart + 1;
      output.selectionEnd = caretPosStart + 1;
    }
  }

  unpress() {
    if (this.code.match(/Caps/)) {
      this.keyboard.capsKeyPressed = false;
      if (this.keyboard.caps) {
        return;
      }
    }
    this.element.classList.remove('keyboard__key_active');
    if (this.code.match(/Control/)) {
      if (this.code.match(/Left/)) {
        this.keyboard.ctrlLeft = false;
      } else {
        this.keyboard.ctrlRight = false;
      }
      return;
    }
    if (this.code.match(/Alt/)) {
      if (this.code.match(/Left/)) {
        this.keyboard.altLeft = false;
      } else {
        this.keyboard.altRight = false;
      }
    }

    if (this.code.match(/Shift/)) {
      if (this.code.match(/Left/)) {
        this.keyboard.shiftLeft = false;
      } else {
        this.keyboard.shiftRight = false;
      }
      this.keyboard.switchCase();
    }
  }

  switchCase() {
    const {
      lang, caps, shiftLeft, shiftRight,
    } = this.keyboard;
    const { shift, value } = this.data[lang];
    if (shift) {
      this.title.innerHTML = '';
      this.subtitle.innerHTML = '';
      if (!caps) {
        if (shiftLeft || shiftRight) {
          this.title.innerHTML = shift;
          this.currentValue = shift;
          if (shift !== value.toUpperCase()) {
            this.subtitle.innerHTML = value;
          }
        } else {
          this.title.innerHTML = value;
          this.currentValue = value;
          if (shift !== value.toUpperCase()) {
            this.subtitle.innerHTML = shift;
          }
        }
      } else if (shiftLeft || shiftRight) {
        if (shift === value.toUpperCase()) {
          this.title.innerHTML = value;
          this.currentValue = value;
        } else {
          this.title.innerHTML = shift;
          this.currentValue = shift;
          this.subtitle.innerHTML = value;
        }
      } else if (shift === value.toUpperCase()) {
        this.title.innerHTML = shift;
        this.currentValue = shift;
      } else {
        this.title.innerHTML = value;
        this.currentValue = value;
        this.subtitle.innerHTML = shift;
      }
    }
  }

  click() {
    this.press();
    this.element.addEventListener('mouseleave', this.mouseLeave);
    this.element.addEventListener('mouseup', this.mouseLeave);
  }
}

const keyboard = {
  init(lang) {
    this.lang = lang;
    this.layout = [
      ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'Backspace'],
      ['Tab', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backslash', 'Delete'],
      ['CapsLock', 'KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote', 'Enter'],
      ['ShiftLeft', 'KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM', 'Comma', 'Period', 'Slash', 'ArrowUp', 'ShiftRight'],
      ['ControlLeft', 'MetaLeft', 'AltLeft', 'Space', 'AltRight', 'ControlRight', 'ArrowLeft', 'ArrowDown', 'ArrowRight'],
    ];
    this.output = layout.createEl('textarea', {
      classes: ['output'],
      attrs: {
        rows: 8, cols: 64, autofocus: true, spellcheck: false,
      },
    });
    this.container = layout.createEl('div', { classes: ['keyboard'] });

    this.wrapper = layout.createEl('div', { classes: ['wrapper'], content: [this.output, this.container] });

    document.body.append(this.wrapper);

    this.keys = {};
    this.layout.forEach((row) => {
      const rowEl = layout.createEl('div', { classes: ['keyboard__row'], dataset: { keyboardRow: true } });
      row.forEach((keyCode) => {
        const key = new Key(keyCode, lang);
        this.keys[keyCode] = key;
        key.keyboard = this;
        rowEl.append(key.element);
      });

      this.container.append(rowEl);
    });
    this.initListeners();
    return this;
  },

  initListeners() {
    this.shiftLeft = false;
    this.shiftRight = false;
    this.ctrlLeft = false;
    this.ctrlRight = false;
    this.altLeft = false;
    this.altRight = false;
    this.caps = false;
    document.addEventListener('keydown', (e) => { this.eventCatcher(e); });
    document.addEventListener('keyup', (e) => { this.eventCatcher(e); });
    this.container.addEventListener('mousedown', (e) => { this.eventCatcher(e); });
  },

  eventCatcher(e) {
    e.preventDefault();
    e.stopPropagation();
    if (e.type.match(/key/)) {
      const keyCode = e.code;
      const key = this.keys[keyCode];
      if (!key) return;
      if (e.type.match(/down/)) {
        key.press(e.repeat);
      } else {
        key.unpress();
      }
    } else {
      if (e.target === this.container || e.target.dataset.keyboardRow) return;
      const keyElement = e.target.closest('.keyboard__key');
      const key = this.keys[keyElement.dataset.code];
      key.click();
    }
  },

  switchLang() {
    const languages = Object.keys(keysData);
    let nextLangIndex = languages.indexOf(this.lang);
    nextLangIndex = nextLangIndex + 1 >= languages.length ? 0 : nextLangIndex + 1;
    this.lang = languages[nextLangIndex];
    layout.setStorage('lang', this.lang);
    this.switchCase();
  },

  switchCase() {
    Object.keys(this.keys).forEach((keyCode) => {
      this.keys[keyCode].switchCase();
    });
  },
};

(function init() {
  const header = layout.createEl('h1', { content: 'RSS Virtual Keyboard' });
  const subtitle = layout.createEl('h3', { content: 'Клавиатура создана в операционной системе Windows' });
  const info = layout.createEl('h2', { content: 'Для переключения языка: <b>левые</b> Ctrl + Alt' });

  document.body.append(header, subtitle, info);
  layout.keyboard = keyboard.init(layout.getStorage('lang'));
}());
